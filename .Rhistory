dplyr::select(mode, value, species) %>%
dplyr::rename(value_base=value)
model_output1_long_new<-model_output1_long %>%
dplyr::filter(metric=="predicted_trips") %>%
dplyr::select(mode, value, species) %>%
dplyr::rename(value_new=value) %>%
dplyr::left_join(model_output1_long_base, by=c("mode", "species")) %>%
dplyr::mutate(additional_trips=value_new-value_base) %>%
dplyr::mutate(metric="additional_trips") %>%
dplyr::select(metric, mode, additional_trips, species) %>%
dplyr::rename(value=additional_trips)
model_output1_long_base<-model_output1_long %>%
dplyr::filter(metric=="base_trips") %>%
dplyr::select(mode, value, species) %>%
dplyr::rename(value_base=value)
model_output1_long_new<-model_output1_long %>%
dplyr::filter(metric=="predicted_trips") %>%
dplyr::select(mode, value, species) %>%
dplyr::rename(value_new=value) %>%
dplyr::left_join(model_output1_long_base, by=c("mode", "species")) %>%
dplyr::mutate(additional_trips=value_new-value_base) %>%
dplyr::mutate(metric="additional_trips") %>%
dplyr::select(metric, mode, additional_trips, species) %>%
dplyr::rename(value=additional_trips)
model_output1_long %>% model_output1_long %>%
dplyr::bind_rows(model_output1_long_new)
model_output1_long_base<-model_output1_long %>%
dplyr::filter(metric=="base_trips") %>%
dplyr::select(mode, value, species) %>%
dplyr::rename(value_base=value)
model_output1_long_new<-model_output1_long %>%
dplyr::filter(metric=="predicted_trips") %>%
dplyr::select(mode, value, species) %>%
dplyr::rename(value_new=value) %>%
dplyr::left_join(model_output1_long_base, by=c("mode", "species")) %>%
dplyr::mutate(additional_trips=value_new-value_base) %>%
dplyr::mutate(metric="additional_trips") %>%
dplyr::select(metric, mode, additional_trips, species) %>%
dplyr::rename(value=additional_trips)
model_output1_long <- model_output1_long %>%
dplyr::bind_rows(model_output1_long_new)
pattern_vars <- grep(
"^keep_(sf_|bsb_|scup_)[0-9.]*$|^release_(sf_|bsb_|scup_)[0-9.]*$",
names(length_data),
value = TRUE
)
## Select needed columns and add month
length_data1 <- length_data[, .SD, .SDcols = c("date_parsed", "mode", pattern_vars)]
length_data1[, month := lubridate::month(date_parsed)]
## Aggregate sums by mode + month
length_data1 <- length_data1[, lapply(.SD, sum),
by = .(mode, month),
.SDcols = pattern_vars]
## MELT to long
length_data1 <- melt(
length_data1,
id.vars = c("month", "mode"),
variable.name = "Var",
value.name = "number_at_length"
)
## Split Var into keep_release, species, length
length_data1[, c("keep_release", "species", "length") := tstrsplit(Var, "_", fixed = TRUE)]
length_data1[, length := as.numeric(length)]
## Join with l_w_conversion
setDT(l_w_conversion)
length_data1 <- l_w_conversion[length_data1, on = .(month, species)]
## Compute weight
length_data1[, weight := fcase(
species == "scup", exp(ln_a + b * log(length)),
species %chin% c("sf", "bsb"), a * length^b,
default = NA_real_
)]
## Convert to lbs
length_data1[, weight := weight * 2.20462262185]
## Totals
length_data1[, keep_weight := fifelse(keep_release == "keep",
number_at_length * weight,
0)]
length_data1[, release_weight := fifelse(keep_release == "release",
number_at_length * weight,
0)]
length_data1[, keep_numbers := fifelse(keep_release == "keep",
number_at_length,
0)]
length_data1[, release_numbers := fifelse(keep_release == "release",
number_at_length,
0)]
## Discard mortality weight
length_data1[, discmort_weight := fcase(
keep_release == "release" & species == "sf", 0.10 * number_at_length * weight,
keep_release == "release" & species == "scup", 0.15 * number_at_length * weight,
keep_release == "release" & species == "bsb", 0.15 * number_at_length * weight,
default = 0
)]
## Discard mortality numbers
length_data1[, discmort_number := fcase(
keep_release == "release" & species == "sf", 0.10 * number_at_length,
keep_release == "release" & species == "scup", 0.15 * number_at_length,
keep_release == "release" & species == "bsb", 0.15 * number_at_length,
default = 0
)]
## Summarise by species, mode
length_data1 <- length_data1[, .(
keep_numbers = sum(keep_numbers),
release_numbers = sum(release_numbers),
keep_weight = sum(keep_weight),
release_weight = sum(release_weight),
discmort_weight = sum(discmort_weight),
discmort_number = sum(discmort_number)
), by = .(species, mode)]
length_data_long <- melt(
length_data1,
id.vars = c("species", "mode"),   # keep these as identifiers
measure.vars = c("keep_numbers", "release_numbers",
"keep_weight", "release_weight",
"discmort_weight", "discmort_number"),
variable.name = "metric",
value.name = "value"
)
## Remove NAs
length_data_long <- length_data_long[!is.na(value)]
## Split and classify
length_data_long_all <- length_data_long[, .(value = sum(value)),
by = .(metric, species)]
length_data_long_all[, mode := "all modes"]
## Final bind
length_output <- rbindlist(list(length_data_long_all, length_data_long) ,
use.names = TRUE,
fill = TRUE
)
predictions <- rbindlist(
list(length_output, model_output1_long),
use.names = TRUE,
fill = TRUE) %>%
dplyr::mutate(state = st, draw=dr)
predictions<-predictions %>%
dplyr::mutate(state=st, draw=dr)
View(predictions)
Run this script prior to predict rec catch
iterative_input_data_cd="E:/Lou's projects/flukeRDM/flukeRDM_iterative_data"
input_data_cd="C:/Users/andrew.carr-harris/Desktop/MRIP_data_2025"
#check
############# To Run Individual
# Variables to change
dr<-20
st="RI"
directed_trips<-feather::read_feather(file.path(iterative_input_data_cd, paste0("directed_trips_calibration_new/directed_trips_calibration_new_", st, ".feather"))) %>%
tibble::tibble() %>%
dplyr::filter(draw == dr) %>%
dplyr::select(mode, date,
bsb_bag, bsb_min, bsb_bag_y2, bsb_min_y2,
fluke_bag, fluke_min, fluke_bag_y2,fluke_min_y2,
scup_bag, scup_min, scup_bag_y2, scup_min_y2) %>%
dplyr::mutate(fluke_min_SQ=fluke_min, fluke_bag_SQ=fluke_bag,
bsb_min_SQ=bsb_min, bsb_bag_SQ=bsb_bag,
scup_min_SQ=scup_min, scup_bag_SQ=scup_bag)
directed_trips<-feather::read_feather(file.path(iterative_input_data_cd, paste0("directed_trips_calibration_new_", st, ".feather"))) %>%
tibble::tibble() %>%
dplyr::filter(draw == dr) %>%
dplyr::select(mode, date,
bsb_bag, bsb_min, bsb_bag_y2, bsb_min_y2,
fluke_bag, fluke_min, fluke_bag_y2,fluke_min_y2,
scup_bag, scup_min, scup_bag_y2, scup_min_y2) %>%
dplyr::mutate(fluke_min_SQ=fluke_min, fluke_bag_SQ=fluke_bag,
bsb_min_SQ=bsb_min, bsb_bag_SQ=bsb_bag,
scup_min_SQ=scup_min, scup_bag_SQ=scup_bag)
iterative_input_data_cd="E:/Lou's projects/flukeRDM/flukeRDM_iterative_data/directed_trips_calibration_new"
directed_trips<-feather::read_feather(file.path(iterative_input_data_cd, paste0("directed_trips_calibration_new_", st, ".feather"))) %>%
tibble::tibble() %>%
dplyr::filter(draw == dr) %>%
dplyr::select(mode, date,
bsb_bag, bsb_min, bsb_bag_y2, bsb_min_y2,
fluke_bag, fluke_min, fluke_bag_y2,fluke_min_y2,
scup_bag, scup_min, scup_bag_y2, scup_min_y2) %>%
dplyr::mutate(fluke_min_SQ=fluke_min, fluke_bag_SQ=fluke_bag,
bsb_min_SQ=bsb_min, bsb_bag_SQ=bsb_bag,
scup_min_SQ=scup_min, scup_bag_SQ=scup_bag)
packages <- c("tidyr",  "magrittr", "tidyverse", "reshape2", "splitstackshape","doBy","WriteXLS","Rcpp",
"ggplot2","dplyr","rlist","fitdistrplus","MASS","psych","rgl","copula","VineCopula","scales",
"univariateML","logspline","readr","data.table","conflicted", "readxl", "writexl", "fs",
"purrr", "readr", "here","plyr" , "furrr", "profvis", "future", "magrittr", "feather", "RStata", "haven")
lapply(packages, library, character.only = TRUE)
library(plyr)
library(dplyr)
conflicts_prefer(here::here)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::rename)
conflicts_prefer(dplyr::summarize)
conflicts_prefer(dplyr::summarise)
conflicts_prefer(dplyr::count)
directed_trips<-feather::read_feather(file.path(iterative_input_data_cd, paste0("directed_trips_calibration_new_", st, ".feather"))) %>%
tibble::tibble() %>%
dplyr::filter(draw == dr) %>%
dplyr::select(mode, date,
bsb_bag, bsb_min, bsb_bag_y2, bsb_min_y2,
fluke_bag, fluke_min, fluke_bag_y2,fluke_min_y2,
scup_bag, scup_min, scup_bag_y2, scup_min_y2) %>%
dplyr::mutate(fluke_min_SQ=fluke_min, fluke_bag_SQ=fluke_bag,
bsb_min_SQ=bsb_min, bsb_bag_SQ=bsb_bag,
scup_min_SQ=scup_min, scup_bag_SQ=scup_bag)
iterative_input_data_cd="E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/directed_trips_calibration_new"
directed_trips<-feather::read_feather(file.path(iterative_input_data_cd, paste0("directed_trips_calibration_new_", st, ".feather"))) %>%
tibble::tibble() %>%
dplyr::filter(draw == dr) %>%
dplyr::select(mode, date,
bsb_bag, bsb_min, bsb_bag_y2, bsb_min_y2,
fluke_bag, fluke_min, fluke_bag_y2,fluke_min_y2,
scup_bag, scup_min, scup_bag_y2, scup_min_y2) %>%
dplyr::mutate(fluke_min_SQ=fluke_min, fluke_bag_SQ=fluke_bag,
bsb_min_SQ=bsb_min, bsb_bag_SQ=bsb_bag,
scup_min_SQ=scup_min, scup_bag_SQ=scup_bag)
View(directed_trips)
which(is.na(directed_trips))
iterative_input_data_cd="E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/proj_catch_draws_feather"
catch_data <- feather::read_feather(file.path(iterative_input_data_cd, paste0("proj_catch_draws_",st, "_", dr,".feather"))) %>%
dplyr::left_join(directed_trips, by=c("mode", "date"))
View(catch_data)
which(is.na(catch_data))
iterative_input_data_cd="E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/base_outcomes_new"
base_outcomes0[[md]]<-feather::read_feather(file.path(iterative_input_data_cd, paste0("base_outcomes_new_", st, "_", md, "_", dr, ".feather"))) %>%
data.table::as.data.table()
md<-"sh"
# pull trip outcomes from the calibration year
iterative_input_data_cd="E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/base_outcomes_new"
base_outcomes0[[md]]<-feather::read_feather(file.path(iterative_input_data_cd, paste0("base_outcomes_new_", st, "_", md, "_", dr, ".feather"))) %>%
data.table::as.data.table()
st<-"MD"
# Directed trips
statez <- c("MA", "MD", "VA")
good_draws<-read_excel("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/calibration_good_draws_extras.xlsx")) %>%
good_draws<-read_excel("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/calibration_good_draws_extras.xlsx") %>%
dplyr::filter(state==st)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
iterative_input_data_cd="E:/Lou_projects/flukeRDM/flukeRDM_iterative_data"
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
View(good_draws)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")))%>%
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather"))
max(directed_trips$draw)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
max(directed_trips$draw)
max(directed_trips$draw2)
st<-"VA"
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
max(directed_trips$draw)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx"))
View(good_draws)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
View(directed_trips)
# Directed trips
statez <- c("RI", "MD", "VA")
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
write_feather(directed_trips, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/dir_trips_calib_extra_new_", st,".feather"))
}
length_draw_list<-list()
length_draws_st_list<-list()
length_draw_list[[md]][[st]]<-read_csv(file.path(iterative_input_data_cd, "projected_catch_at_length.csv"), show_col_types = FALSE) %>%
dplyr::filter(state==st)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md)
length_draw_list[[md]][[st]]<-read_csv(file.path(iterative_input_data_cd, "projected_catch_at_length.csv"), show_col_types = FALSE) %>%
dplyr::filter(state==st) %>%
dplyr::left_join(good_draws, by=c("state", "draw"))
View(length_draw_list)
View(length_draw_list[["sh"]][["VA"]])
length_draw_list[[md]][[st]]<-read_csv(file.path(iterative_input_data_cd, "projected_catch_at_length.csv"), show_col_types = FALSE) %>%
dplyr::filter(state==st) %>%
dplyr::left_join(good_draws, by=c("state", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2) %>%
dplyr::mutate(mode=md)
statez <- c("RI", "MD", "VA")
modez <- c("sh", "pr", "fh")
length_draw_list<-list()
length_draws_st_list<-list()
for(st in statez){
for(md in modez){
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md)
length_draw_list[[md]][[st]]<-read_csv(file.path(iterative_input_data_cd, "projected_catch_at_length.csv"), show_col_types = FALSE) %>%
dplyr::filter(state==st) %>%
dplyr::left_join(good_draws, by=c("state", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2) %>%
dplyr::mutate(mode=md)
}
}
length_draws <- dplyr::bind_rows(purrr::flatten(length_draw_list))
View(length_draw_list)
View(length_draws)
write_csv(length_draws, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/projected_catch_at_length_extra_new.csv"))
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv")), show_col_types = FALSE) %>%
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE))
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE) %>%
dplyr::filter(state == st) %>%
dplyr::left_join(good_draws, by=c("mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::mutate(draw=draw2)%>%
dplyr::select(-draw2)
View(calendar_adj)
View(length_draws)
View(directed_trips)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE) %>%
dplyr::filter(state == st) %>%
dplyr::left_join(good_draws, by=c("mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::mutate(draw=draw2)%>%
dplyr::select(-draw2)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st) %>%
dplyr::select(-state)
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE) %>%
dplyr::filter(state == st) %>%
dplyr::left_join(good_draws, by=c("mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::mutate(draw=draw2)%>%
dplyr::select(-draw2)
# Calendar year adjustments
statez <- c("RI", "MD", "VA")
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st) %>%
dplyr::select(-state)
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE) %>%
dplyr::filter(state == st) %>%
dplyr::left_join(good_draws, by=c("mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::mutate(draw=draw2)%>%
dplyr::select(-draw2)
write_csv(calendar_adj, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_year_calendar_adjustments_new_", st, ".csv"))
}
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md & draw2==dr)
View(good_draws)
dr<-105
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md & draw2==dr)
View(good_draws)
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md & draw2==dr)
draw_orig<-mean(good_draws$draw)
base_outcomes_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/base_outcomes/base_outcomes_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
# pull in data on the number of choice occasions per mode-day
n_choice_occasions_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/n_choice_occasion/n_choice_occasions_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
statez <- c("RI", "MD", "VA")
mode_draw <- c("sh", "pr", "fh")
for(dr in 101:105){
for (md in mode_draw) {
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md & draw2==dr)
draw_orig<-mean(good_draws$draw)
# pull trip outcomes from the calibration year
base_outcomes_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/base_outcomes/base_outcomes_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
write_feather(base_outcomes_in, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/base_outcomes_new_", st, "_", md, "_", dr, ".feather"))
# pull in data on the number of choice occasions per mode-day
n_choice_occasions_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/n_choice_occasion/n_choice_occasions_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
write_feather(n_choice_occasions_in, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/n_choice_occasions_new_", st, "_", md, "_", dr, ".feather"))
}
}
}
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx"))
calib_comparison<-readRDS("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/calibrated_model_stats.rds") %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
View(calib_comparison)
# Directed trips
statez <- c("RI", "MD", "VA")
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st)
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/directed_trips_calibration/directed_trips_calibration_", st, ".feather")) %>%
dplyr::left_join(good_draws, by=c("state", "mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2)
write_feather(directed_trips, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/directed_trips_calibration_new_extra_", st,".feather"))
}
# Projected catch-at-length *note for Kim that this file now contains distn's by mode
statez <- c("RI", "MD", "VA")
modez <- c("sh", "pr", "fh")
length_draw_list<-list()
length_draws_st_list<-list()
for(st in statez){
for(md in modez){
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md)
length_draw_list[[md]][[st]]<-read_csv(file.path(iterative_input_data_cd, "projected_catch_at_length.csv"), show_col_types = FALSE) %>%
dplyr::filter(state==st) %>%
dplyr::left_join(good_draws, by=c("state", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::select(-draw) %>%
dplyr::rename(draw=draw2) %>%
dplyr::mutate(mode=md)
}
}
length_draws <- dplyr::bind_rows(purrr::flatten(length_draw_list))
write_csv(length_draws, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/projected_catch_at_length_new_extra.csv"))
# Calendar year adjustments
statez <- c("RI", "MD", "VA")
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st) %>%
dplyr::select(-state)
calendar_adj<- readr::read_csv(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/miscellaneous/proj_year_calendar_adjustments/proj_year_calendar_adjustments_", st, ".csv"), show_col_types = FALSE) %>%
dplyr::filter(state == st) %>%
dplyr::left_join(good_draws, by=c("mode", "draw")) %>%
dplyr::filter(!is.na(draw2)) %>%
dplyr::mutate(draw=draw2)%>%
dplyr::select(-draw2)
write_csv(calendar_adj, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_year_calendar_adjustments_new_extra_", st, ".csv"))
}
# Baseline year outcomes and number of choice occasions
statez <- c("RI", "MD", "VA")
mode_draw <- c("sh", "pr", "fh")
for(dr in 101:105){
for (md in mode_draw) {
for(st in statez) {
good_draws<-read_excel(file.path(iterative_input_data_cd, "calibration_good_draws_extras.xlsx")) %>%
dplyr::filter(state==st & mode==md & draw2==dr)
draw_orig<-mean(good_draws$draw)
# pull trip outcomes from the calibration year
base_outcomes_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/base_outcomes/base_outcomes_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
write_feather(base_outcomes_in, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/base_outcomes_new_extra_", st, "_", md, "_", dr, ".feather"))
# pull in data on the number of choice occasions per mode-day
n_choice_occasions_in<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/n_choice_occasion/n_choice_occasions_", st, "_", md, "_", draw_orig, ".feather")) %>%
data.table::as.data.table()
write_feather(n_choice_occasions_in, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/n_choice_occasions_new_extra_", st, "_", md, "_", dr, ".feather"))
}
}
}
library(writexl)
statez <- c("RI", "MD", "VA")
for(st in statez) {
directed_trips<-feather::read_feather(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/directed_trips_calibration_new_extra_", st,".feather"))
write_xlsx(directed_trips, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/directed_trips_calibration_new_extra_", st, ".xlsx"))
}
statez <- c("RI", "MD", "VA")
k<-101
for(st in statez) {
for(dr in c(27, 84, 6, 59, 42)){
proj_catch<-read_excel(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/proj_catch_draws_xlsdta/proj_catch_draws_", st,"_", dr, ".xlsx"))
write_xlsx(proj_catch, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_catch_draws_extra_", st, "_", k, ".xlsx"))
k<-k+1
}
}
statez <- c("RI", "MD", "VA")
for(st in statez) {
k<-101
for(dr in c(27, 84, 6, 59, 42)){
proj_catch<-read_excel(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/archive/proj_catch_draws_xlsdta/proj_catch_draws_", st,"_", dr, ".xlsx"))
write_xlsx(proj_catch, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_catch_draws_extra_", st, "_", k, ".xlsx"))
k<-k+1
}
}
# Step 3
# Transfer projected catch draw files from .dta to .feather
statez <- c("RI", "MD", "VA")
for(s in statez) {
for(i in 101:105) {
catch<-read_dta(paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_catch_draws_extra_",s, "_", i,".dta"))
write_feather(catch, paste0("E:/Lou_projects/flukeRDM/flukeRDM_iterative_data/additional_draws/proj_catch_draws_extra_",s, "_", i,".feather"))
}
}
